= Vehicle routing with real road distances
:page-interpolate: true
:awestruct-author: ge0ffrey
:awestruct-layout: blogPostBase
:awestruct-tags: [vehicle routing, insight]

In the real world, vehicles in a Vehicle Routing Problem (VRP) have to follow the roads:
they can't travel in a straight line from customer to customer.
Most VRP research papers and demo's happily ignore this implementation detail. As did I too, in the past.
Although using road distances (instead of air distances) doesn't impact the NP-hard nature of a VRP much,
it does result in a few extra challenges. Let's take a look at those challenges.

== Datasets with road distances

First off, we need realistic datasets.
Unfortunately, public VRP datasets with road distances are scarce in the VRP research community.
The http://neo.lcc.uma.es/vrp/[VRP Web] has few small ones, such as a dataset of Bavaria with 29 locations,
but no big ones. This needs to be tested more thoroughly, so I had to generate datasets with the following requirements:

. Use _Google Maps like_ roads with real distances in km between every locations in the dataset.
    * For example, use highways when reasonable, even if town roads have a shorter distance.
. For every dataset, generate an air distance variant and a road distance variant, to compare results.
. Generate a similar dataset in multiple orders of magnitude, to compare scalability.
. Add reasonable vehicle capacities and customer demands, for the capacity constraint in VRP.

I ended up generating datasets of Belgium with a location for each city, town and subtown:

image::belgium-datasets-unsolved.png[]

By using the excellent Java library https://graphhopper.com/[GraphHopper],
based on http://www.openstreetmap.org[OpenStreetMap], this was relatively easy.
As long as the entire road network (only 200MB for Belgium) can be loaded into memory.
Loading the entire road network of North-America (6GB) is a bit more challenging.
Of course, I 'll submit these datasets to the VRP Web too, so others researchers can use them too.

All this happens _before_ http://www.optaplanner.org/[OptaPlanner]'s VRP example starts solving it.
During solving, the distances are already cached.
Once we get to +1000+ locations, pre-calculating all distances between every location pair can introduce memory and performance issues.
I'll explain those and the remedies in my next blog.

== Air distance vs Road distance

The dataset +belgium-n50-k10.vrp+ has +50+ locations and +10+ vehicles with capacity 125.
We give OptaPlanner 5 minutes to solve it.

Using *air distances* (which calculates the euclidean distance based on latitude and longitude), we get:

image::belgium-n52-airSolution.png[]

The +22.99+ fuel doesn't mean much. We need to apply *this air distance solution on the real road network*,
to know the real distance:

image::belgium-road-n51-airSolution.png[]

Below is the *road distance* solution. Compare it with the air distance solution above:

image::belgium-road-n50-roadSolution.png[]

The road distance solution is +108.45+ km (or almost 5%) better!
And that's on one of the most dense road network is the world (Belgium's road network).

== Scaling out



== Conclusion

Using real distances in VRP does matter.
Solving an VRP with air distances and then apply road distances is suboptimal.
